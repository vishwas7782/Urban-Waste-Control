<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Urban Waste Control</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body onload="checkLogin(); loadDashboard();"> <!-- Load the dashboard based on user role -->
    <header>
        <nav>
            <div class="logo">
                <a href="index.html">
                    <img src="images/logo2NoBg.png" alt="Urban Waste Control Logo">
                    <span>Urban Waste Control</span>
                </a>
            </div>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li> <!-- Logout -->
            </ul>
        </nav>
    </header>

    <!-- Dashboard Section -->
    <section id="dashboard" class="dashboard-section">
        <div class="container">
            <h1>Welcome to your Dashboard</h1>
            <p id="role"></p>

            <!-- User Section -->
            <div id="userDashboard" class="dashboard" style="display: none;">
                <h2>Public User Actions</h2>
                <button id="raiseConcernBtn" onclick="toggleConcernForm()">Raise Concern</button>
                <div id="concernForm" style="display: none;">
                    <h3>Raise a Concern</h3>
                    <form id="raiseConcernForm" onsubmit="submitConcern(event)">
                        <label for="description">Concern Description:</label>
                        <textarea id="description" name="description" required></textarea>
                        <button type="submit">Submit Concern</button>
                    </form>
                </div>

                <h2>View Garbage Collection Schedule</h2>
                <div id="schedule"></div>

                <h2>Report Garbage at Public Place</h2>
                <form id="publicGarbageForm" onsubmit="reportGarbage(event)">
                    <label for="garbageLocation">Location:</label>
                    <input type="text" id="garbageLocation" name="garbageLocation" required>
                    <label for="garbageImage">Upload Image:</label>
                    <input type="file" id="garbageImage" name="garbageImage" accept="image/*" required>
                    <button type="submit">Report Garbage</button>
                </form>
            </div>

            <!-- Municipal Employee Section -->
            <div id="employeeDashboard" class="dashboard" style="display: none;">
                <h2>Municipal Employee Actions</h2>

                <h3>View Concerns Raised by Users</h3>
                <div id="userConcerns"></div>

                <h3>Update Garbage Collection Schedule</h3>
                <form id="updateScheduleForm" onsubmit="updateSchedule(event)">
                    <label for="scheduleDate">Date:</label>
                    <input type="date" id="scheduleDate" name="scheduleDate" required>
                    <label for="scheduleTime">Time:</label>
                    <input type="time" id="scheduleTime" name="scheduleTime" required>
                    <button type="submit">Update Schedule</button>
                </form>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <p>Urban Waste Control System | Â© 2024 All rights reserved</p>
        </div>
    </footer>

    <!-- Include JavaScript -->
    <script src="auth.js"></script>
    <script>
        // Load the dashboard based on user role
        function loadDashboard() {
            const role = localStorage.getItem('role'); // Fetch role from localStorage

            if (role === 'user') {
                document.getElementById('role').textContent = 'You are logged in as a Public User';
                document.getElementById('userDashboard').style.display = 'block';
                loadSchedule(); // Load the garbage collection schedule for users
            } else if (role === 'municipal') {
                document.getElementById('role').textContent = 'You are logged in as a Municipal Employee';
                document.getElementById('employeeDashboard').style.display = 'block';
                loadUserConcerns(); // Load concerns for municipal employees
            } else {
                alert('Invalid role or not logged in');
                window.location.href = 'login.html'; // Redirect to login if no valid role
            }
        }

        // Toggle concern form visibility
        function toggleConcernForm() {
            const concernForm = document.getElementById('concernForm');
            concernForm.style.display = (concernForm.style.display === 'none') ? 'block' : 'none';
        }

        // Handle logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            window.location.href = 'login.html';
        }

        // Submit concern for public users
        async function submitConcern(event) {
            event.preventDefault();
            const description = document.getElementById('description').value;

            try {
                const response = await fetch('/raise-concern', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token') // Add the token from localStorage
                    },
                    body: JSON.stringify({ description })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Concern raised successfully');
                    document.getElementById('description').value = ''; // Clear the form
                } else {
                    alert('Error raising concern: ' + data.message);
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        // Load garbage collection schedule for public users
        async function loadSchedule() {
            try {
                const response = await fetch('/view-schedule', {
                    headers: {
                        'Authorization': localStorage.getItem('token') // Add the token from localStorage
                    }
                });
                const data = await response.json();
                const scheduleDiv = document.getElementById('schedule');
                scheduleDiv.innerHTML = ''; // Clear previous content

                // Loop through and display the schedule
                data.schedule.forEach(schedule => {
                    scheduleDiv.innerHTML += `<p>${schedule.date} - ${schedule.time}</p>`;
                });
            } catch (error) {
                alert('Error loading schedule: ' + error);
            }
        }

        // Report public garbage for public users
        async function reportGarbage(event) {
            event.preventDefault();
            const location = document.getElementById('garbageLocation').value;
            const image = document.getElementById('garbageImage').files[0];

            const formData = new FormData();
            formData.append('location', location);
            formData.append('image', image);

            try {
                const response = await fetch('/report-public-garbage', {
                    method: 'POST',
                    headers: {
                        'Authorization': localStorage.getItem('token') // Add the token from localStorage
                    },
                    body: formData // Send formData (including image)
                });

                const data = await response.json();
                if (data.success) {
                    alert('Garbage reported successfully');
                    document.getElementById('garbageLocation').value = ''; // Clear the form
                    document.getElementById('garbageImage').value = ''; // Clear the image field
                } else {
                    alert('Error reporting garbage: ' + data.message);
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        // Load concerns for municipal employees
        async function loadUserConcerns() {
            try {
                const response = await fetch('/view-concerns', {
                    headers: {
                        'Authorization': localStorage.getItem('token') // Add the token from localStorage
                    }
                });
                const data = await response.json();
                const concernsDiv = document.getElementById('userConcerns');
                concernsDiv.innerHTML = ''; // Clear previous content

                // Loop through and display user concerns
                data.concerns.forEach(concern => {
                    concernsDiv.innerHTML += `<p>${concern.description} - ${concern.status}</p>`;
                });
            } catch (error) {
                alert('Error loading concerns: ' + error);
            }
        }

        // Update garbage collection schedule for municipal employees
        async function updateSchedule(event) {
            event.preventDefault();
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;

            try {
                const response = await fetch('/update-schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token') // Add the token from localStorage
                    },
                    body: JSON.stringify({ date, time })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Schedule updated successfully');
                    document.getElementById('scheduleDate').value = ''; // Clear the form
                    document.getElementById('scheduleTime').value = ''; // Clear the form
                } else {
                    alert('Error updating schedule: ' + data.message);
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        }
    </script>
</body>
</html>
